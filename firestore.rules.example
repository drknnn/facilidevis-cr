/**
 * Règles de sécurité Firestore pour FaciliDevis
 * 
 * Copiez ce fichier dans votre console Firebase :
 * Firebase Console > Firestore Database > Règles
 * 
 * IMPORTANT : Ces règles garantissent qu'un utilisateur ne peut accéder qu'à ses propres données
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Vérifier que l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Vérifier que l'utilisateur est propriétaire de la ressource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================
    // COLLECTION: users
    // ============================================
    // Un utilisateur peut lire son propre profil
    // Un utilisateur peut mettre à jour son propre profil
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // ============================================
    // COLLECTION: clients
    // ============================================
    // Un utilisateur peut lire/écrire uniquement ses propres clients
    match /clients/{clientId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ============================================
    // COLLECTION: quotes (devis)
    // ============================================
    // Un utilisateur peut lire/écrire uniquement ses propres devis
    match /quotes/{quoteId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
      
      // Sous-collection : items (lignes de devis)
      match /items/{itemId} {
        allow read: if isOwner(get(/databases/$(database)/documents/quotes/$(quoteId)).data.userId);
        allow write: if isOwner(get(/databases/$(database)/documents/quotes/$(quoteId)).data.userId);
      }
    }
    
    // ============================================
    // COLLECTION: reminders (relances)
    // ============================================
    // Un utilisateur peut lire/écrire uniquement ses propres relances
    match /reminders/{reminderId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ============================================
    // COLLECTION: signatures
    // ============================================
    // Un utilisateur peut lire les signatures de ses devis
    // Les signatures sont créées depuis l'API (pas directement par les utilisateurs)
    match /signatures/{signatureId} {
      allow read: if isAuthenticated();
      allow write: if false; // Les signatures sont créées uniquement depuis l'API serveur
    }
    
    // ============================================
    // COLLECTION: subscriptions (abonnements Stripe)
    // ============================================
    // Un utilisateur peut lire son propre abonnement
    match /subscriptions/{subscriptionId} {
      allow read: if isOwner(resource.data.userId);
      allow write: if false; // Les abonnements sont gérés uniquement depuis l'API serveur (webhooks Stripe)
    }
    
    // ============================================
    // COLLECTION: activities (logs d'activité - optionnel)
    // ============================================
    // Un utilisateur peut lire uniquement ses propres activités
    match /activities/{activityId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow write: if false; // Les activités ne sont jamais modifiées
    }
    
    // ============================================
    // DÉFAUT : Tout le reste est refusé
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

